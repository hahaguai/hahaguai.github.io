<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="hahaguai's blog" type="application/atom+xml" />






<meta name="description" content="[toc] tcpdump+pt-query-digest学习目标：  使用tcpdump命令按照一定规则抓取数据包，然后转储到中间文件 使用pt-query-digest对中间文件按照一定规则进行分析  tcpdumptcpdump是一个强大的命令，这里我们只是讨论一些关于tcp的输出典型方法，因为MySQL就是使用tcp（可靠）传输数据的。1[root@archpredb214  ~]#tcp">
<meta property="og:type" content="article">
<meta property="og:title" content="hahaguai&#39;s blog">
<meta property="og:url" content="http://yoursite.com/2018/02/07/tcpdump+pt-query-digest/index.html">
<meta property="og:site_name" content="hahaguai&#39;s blog">
<meta property="og:description" content="[toc] tcpdump+pt-query-digest学习目标：  使用tcpdump命令按照一定规则抓取数据包，然后转储到中间文件 使用pt-query-digest对中间文件按照一定规则进行分析  tcpdumptcpdump是一个强大的命令，这里我们只是讨论一些关于tcp的输出典型方法，因为MySQL就是使用tcp（可靠）传输数据的。1[root@archpredb214  ~]#tcp">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://img3.ph.126.net/vBeH9eDewhj4Kx24a1m0dA==/2791950294010152753.jpg">
<meta property="og:updated_time" content="2018-01-31T02:29:26.387Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="hahaguai&#39;s blog">
<meta name="twitter:description" content="[toc] tcpdump+pt-query-digest学习目标：  使用tcpdump命令按照一定规则抓取数据包，然后转储到中间文件 使用pt-query-digest对中间文件按照一定规则进行分析  tcpdumptcpdump是一个强大的命令，这里我们只是讨论一些关于tcp的输出典型方法，因为MySQL就是使用tcp（可靠）传输数据的。1[root@archpredb214  ~]#tcp">
<meta name="twitter:image" content="http://img3.ph.126.net/vBeH9eDewhj4Kx24a1m0dA==/2791950294010152753.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/02/07/tcpdump+pt-query-digest/"/>





  <title> | hahaguai's blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">hahaguai's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">各种鬼使</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/07/tcpdump+pt-query-digest/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="杨昆">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hahaguai's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline"></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-07T16:57:33+08:00">
                2018-02-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>[toc]</p>
<h2 id="tcpdump-pt-query-digest"><a href="#tcpdump-pt-query-digest" class="headerlink" title="tcpdump+pt-query-digest"></a>tcpdump+pt-query-digest</h2><p>学习目标：</p>
<ul>
<li>使用tcpdump命令按照一定规则抓取数据包，然后转储到中间文件</li>
<li>使用pt-query-digest对中间文件按照一定规则进行分析</li>
</ul>
<h3 id="tcpdump"><a href="#tcpdump" class="headerlink" title="tcpdump"></a>tcpdump</h3><p>tcpdump是一个强大的命令，这里我们只是讨论一些关于tcp的输出典型方法，因为MySQL就是使用tcp（可靠）传输数据的。<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@archpredb214  ~]#tcpdump -s 65535 -x -nn -q -tttt -i any -c 100000<span class="built_in"> port </span>3306 &gt;dmp.txt</span><br></pre></td></tr></table></figure></p>
<blockquote>
<ul>
<li>-s 65535 或者 -s 0都表示抓取一个完整的数据包，在IP数据包中==总长度=首部+数据部分==，因此如下图所示，总长度共16~31,16bit，2^16-1=65535，即抓取整个数据包。</li>
</ul>
</blockquote>
<p><img src="http://img3.ph.126.net/vBeH9eDewhj4Kx24a1m0dA==/2791950294010152753.jpg" alt="image"></p>
<blockquote>
<ul>
<li><p>-x  打印每个数据包包头跟数据包内容，要想分析数据，这个参数是必须的；下面是命令加  -x参数  跟不加 –x参数的区别。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@archpredb214 ~]# tcpdump -s 65535 -x -nn -q -tttt -i any -c 100000<span class="built_in"> port </span>3306    #有选项 -x</span><br><span class="line">tcpdump: verbose output suppressed, use -v <span class="keyword">or</span> -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on any, link-type LINUX_SLL (Linux cooked), capture size 65535 bytes</span><br><span class="line">2018-01-24 09:49:54.443184<span class="built_in"> IP </span>10.27.139.178.57940 &gt; 10.27.139.176.3306: tcp 0</span><br><span class="line">	0x0000:  4500 0034 430d 4000 4006 cc1e 0a1b 8bb2</span><br><span class="line">	0x0010:  0a1b 8bb0 e254 0cea e057 2c39 e536 d965</span><br><span class="line">	0x0020:  8011 007b 7867 0000 0101 080a 1676 5325</span><br><span class="line">	0x0030:  1606 9833</span><br><span class="line"><span class="comment">#有16进制数据包内容</span></span><br><span class="line"><span class="built_in">..</span>.</span><br><span class="line">[root@archpredb214 ~]# tcpdump -s 65535  -nn -q -tttt -i any -c 100000<span class="built_in"> port </span>3306         #无选项 -x</span><br><span class="line">tcpdump: verbose output suppressed, use -v <span class="keyword">or</span> -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on any, link-type LINUX_SLL (Linux cooked), capture size 65535 bytes</span><br><span class="line">2018-01-24 09:50:16.107281<span class="built_in"> IP </span>127.0.0.1.43489 &gt; 127.0.0.1.3306: tcp 0</span><br><span class="line">2018-01-24 09:50:16.107293<span class="built_in"> IP </span>127.0.0.1.3306 &gt; 127.0.0.1.43489: tcp 0</span><br><span class="line"><span class="built_in">..</span>.</span><br><span class="line"><span class="comment">#注意这里是没有数据包内容的</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>-nn  不解析ip到主机名、端口号到服务名，而是直接以 ip、port的形式显示。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@archpredb214 ~]# tcpdump -s 65535 -x -nn -q -tttt -i any -c 100000<span class="built_in"> port </span>3306    #有选项 -nn</span><br><span class="line">tcpdump: verbose output suppressed, use -v <span class="keyword">or</span> -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on any, link-type LINUX_SLL (Linux cooked), capture size 65535 bytes</span><br><span class="line">2018-01-24 09:49:54.443184<span class="built_in"> IP </span>10.27.139.178.57940 &gt; 10.27.139.176.3306: tcp 0  </span><br><span class="line"><span class="comment">#注意主机名、端口部分</span></span><br><span class="line">	0x0000:  4500 0034 430d 4000 4006 cc1e 0a1b 8bb2</span><br><span class="line">	0x0010:  0a1b 8bb0 e254 0cea e057 2c39 e536 d965</span><br><span class="line">	0x0020:  8011 007b 7867 0000 0101 080a 1676 5325</span><br><span class="line">	0x0030:  1606 9833</span><br><span class="line"><span class="built_in">..</span>.</span><br><span class="line"><span class="built_in">..</span>.</span><br><span class="line">[root@archpredb214 ~]# tcpdump -s 65535 -x  -q -tttt -i any -c 100000<span class="built_in"> port </span>3306    #无选项 -nn</span><br><span class="line">tcpdump: verbose output suppressed, use -v <span class="keyword">or</span> -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on any, link-type LINUX_SLL (Linux cooked), capture size 65535 bytes</span><br><span class="line">2018-01-24 10:01:31.397868<span class="built_in"> IP </span>localhost.43489 &gt; localhost.mysql: tcp 19</span><br><span class="line"><span class="comment">#注意主机名、端口部分</span></span><br><span class="line">	0x0000:  4508 0047 e96b 4000 4006 533b 7f00 0001</span><br><span class="line">	0x0010:  7f00 0001 a9e1 0cea ae56 4f04 fecc 12a2</span><br><span class="line">	0x0020:  8018 0101 fe3b 0000 0101 080a 1680 f5a0</span><br><span class="line">	0x0030:  1676 a7c7 0f00 0000 0373 686f 7720 6461</span><br><span class="line">	0x0040:  7461 6261 7365 73</span><br></pre></td></tr></table></figure>
</li>
<li><p>-q 安静输出，很少打印有关协议的信息，所以这个选项也要使用。下面是不加-q参数额显示，有很长的一部分对于统计分析没有意义</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@archpredb214 ~]#  tcpdump -s 65535 -x  -nn  -tttt -i any -c 100000<span class="built_in"> port </span>3306</span><br><span class="line">tcpdump: verbose output suppressed, use -v <span class="keyword">or</span> -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on any, link-type LINUX_SLL (Linux cooked), capture size 65535 bytes</span><br><span class="line">2018-01-24 10:09:41.913854<span class="built_in"> IP </span>127.0.0.1.43489 &gt; 127.0.0.1.3306: Flags [P.], seq 2924891927:2924891946, ack 4274787189, win 265, options [nop,nop,TS val 378040756 ecr 377550240], length 19    #不加-q的额外输出显示</span><br><span class="line">	0x0000:  4508 0047 e96d 4000 4006 5339 7f00 0001</span><br><span class="line">	0x0010:  7f00 0001 a9e1 0cea ae56 4f17 fecc 1375</span><br><span class="line">	0x0020:  8018 0109 fe3b 0000 0101 080a 1688 71b4</span><br><span class="line">	0x0030:  1680 f5a0 0f00 0000 0373 686f 7720 6461</span><br><span class="line">	0x0040:  7461 6261 7365 73</span><br></pre></td></tr></table></figure>
</li>
<li><p>-tttt 在每行打印前打印日期，有必要，作为时间统计。</p>
</li>
<li><p>-i any 抓取所有网口的包（不包括lo），其实这里抓取 eth0就可以了。下面是关于<code>man tcpdump</code> 的 -i选项输出</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-i     Listen on interface.  <span class="keyword">If</span> unspecified, tcpdump searches the<span class="built_in"> system interface </span>list <span class="keyword">for</span> the lowest numbered, configured up<span class="built_in"> interface </span>(excluding</span><br><span class="line">       loopback).  Ties are broken by choosing the earliest match.</span><br><span class="line"></span><br><span class="line">       On  Linux systems with 2.2 <span class="keyword">or</span> later kernels, an<span class="built_in"> interface </span>argument of ‘‘any’’ can be used <span class="keyword">to</span> capture packets <span class="keyword">from</span> all interfaces. <span class="built_in"> Note </span>that</span><br><span class="line">       captures on the ‘‘any’’ device will <span class="keyword">not</span> be done <span class="keyword">in</span> promiscuous mode.</span><br><span class="line"></span><br><span class="line">       <span class="keyword">If</span> the -D flag is supported, an<span class="built_in"> interface </span>number as printed by that flag can be used as the<span class="built_in"> interface </span>argument.</span><br></pre></td></tr></table></figure>
</li>
<li><p>-c 100000  抓取10w个数据包</p>
</li>
<li>port 3306 端口号</li>
</ul>
</blockquote>
<h3 id="pt-query-digest"><a href="#pt-query-digest" class="headerlink" title="pt-query-digest"></a>pt-query-digest</h3><p>这其实是percona的一个脚本工具，当然需要解决依赖关系。<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@archpredb214</span> ~]<span class="meta">#yum -y install perl perl-IO-Socket-SSL perl-DBD-MySQL perl-Time-HiRes</span></span><br><span class="line">...</span><br><span class="line">[root<span class="symbol">@archpredb214</span> ~]<span class="meta">#wget percona.com/get/percona-toolkit.rpm</span></span><br><span class="line">...</span><br><span class="line">rpm -ivh percona-toolkit<span class="number">-2.1</span><span class="number">.7</span><span class="number">-1.</span>noarch.rpm</span><br><span class="line">...</span><br><span class="line">[root<span class="symbol">@archpredb214</span> ~]<span class="meta"># find  / -name <span class="string">'pt-query-digest'</span></span></span><br><span class="line">/home/mysql/mysql_tools/pt-query-digest</span><br><span class="line">[root<span class="symbol">@archpredb214</span> ~]<span class="meta">#</span></span><br></pre></td></tr></table></figure></p>
<p>Usage: <code>pt-query-digest [OPTIONS] [FILES] [DSN]</code><em>该命令支持stdin</em></p>
<p>典型分析用法</p>
<ol>
<li><p>分析慢日志<br><code>[root@archpredb214 ~]#/home/mysql/mysql_tools/pt-query-digest slow.log</code></p>
</li>
<li><p>分析tcpdump工具抓取的数据包转储文件  <code>mysql.tcp.txt</code>  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@archpredb214 ~]<span class="selector-id">#tcpdump</span> -s <span class="number">65535</span> -x -nn -<span class="selector-tag">q</span> -tttt -<span class="selector-tag">i</span> any -c <span class="number">1000</span> port <span class="number">3306</span> &gt; mysql<span class="selector-class">.tcp</span><span class="selector-class">.txt</span></span><br><span class="line">[root@archpredb214 ~]#/home/mysql/mysql_tools/pt-query-digest --type tcpdump mysql<span class="selector-class">.tcp</span><span class="selector-class">.txt</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<blockquote>
<ul>
<li>-type [binlog | genlog | slowlog | tcpdump]</li>
</ul>
</blockquote>
<p> 指定<code>pt-query-digest</code>要分析的文件类型</p>
<ul>
<li>第一部分，总体统计结果(这里以慢查询日志为例子分析)<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">  [root@archpredb214 data]# /home/mysql/mysql_tools/pt-query-digest --type=slowlog             ./archpredb214-slow.log </span><br><span class="line"><span class="meta"> #</span><span class="bash"> 170ms user time, 10ms system time, 23.39M rss, 180.74M vsz</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> Current date: Wed Jan 24 14:23:02 2018</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> Hostname: archpredb214</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> Files: ./archpredb214-slow.log</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> Overall: 2 total, 2 unique, 0 QPS, 0x concurrency ______________________</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> Time range: all events occurred at 2017-10-13 15:36:25</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> Attribute          total     min     max     avg     95%  stddev  median</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> ============     ======= ======= ======= ======= ======= ======= =======</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> Exec time             2s   517ms      1s   759ms      1s   342ms   759ms</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> Lock time          176us    63us   113us    88us   113us    35us    88us</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> Rows sent              0       0       0       0       0       0       0</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> Rows examine     208.00k       0 208.00k 104.00k 208.00k 147.08k 104.00k</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> Rows affecte     104.00k       0 104.00k  52.00k 104.00k  73.54k  52.00k</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> Rows <span class="built_in">read</span>              0       0       0       0       0       0       0</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> Bytes sent            72      11      61      36      61   35.36      36</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> Tmp tables             0       0       0       0       0       0       0</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> Tmp disk tbl           0       0       0       0       0       0       0</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> Tmp tbl size           0       0       0       0       0       0       0</span></span><br><span class="line"><span class="meta"> #</span><span class="bash"> Query size           271     121     150  135.50     150   20.51  135.50</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>如上输出，后面的数据省略。</p>
<ul>
<li>Overall（位于第6行）：2 total 表示总共有多少查询，这里一共两行； 2 unique 唯一查询的数量，这里一共两个；假设都是同一个SQL那么这个值应该为1。</li>
<li>Time range ：表示时间范围，上表中表示的是所有的慢查询都发生在 2017-10-13 15:36:25</li>
</ul>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align:center">Attribute <br><br>属性</th>
<th style="text-align:center">total   <br><br>共计</th>
<th style="text-align:center">min <br><br>最小</th>
<th style="text-align:center">max<br><br>最大</th>
<th style="text-align:center">avg<br><br>平均</th>
<th style="text-align:center">95%<br><br>95%置信区间</th>
<th>stddev<br><br>标准差</th>
<th>median<br><br>中位数</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Exec time<br><br>执行时间</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">Lock time<br><br>锁时间</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">Rows sent<br><br>查询返回的行数</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">Rows examine<br><br>查询检查的行数</td>
</tr>
</tbody>
</table>
<p>….<br>95%:正态分布，95%，就是去掉极端情况</p>
<ul>
<li>第二部分，查询分组统计结果(还是以上面第一部分的命令为例)<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Profile</span><br><span class="line"># Rank Query ID           Response time Calls R/Call V/M   Item</span><br><span class="line"># ==== ================== ============= ===== ====== ===== ===============</span><br><span class="line">#    <span class="number">1</span> <span class="number">0x106F26B3D217B2C9</span>  <span class="number">1.0003</span> <span class="number">65.9</span>%     <span class="number">1</span> <span class="number">1.0003</span>  <span class="number">0.00</span> </span><br><span class="line">#    <span class="number">2</span> <span class="number">0x01C3BF9ABB566E2C</span>  <span class="number">0.5170</span> <span class="number">34.1</span>%     <span class="number">1</span> <span class="number">0.5170</span>  <span class="number">0.00</span> INSERT SELECT    test.group_message group_message</span><br></pre></td></tr></table></figure>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">Column</th>
<th style="text-align:center">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Rank</td>
<td style="text-align:center">The query’s rank within the entire set of queries analyzed</td>
</tr>
<tr>
<td style="text-align:center">Query ID</td>
<td style="text-align:center">The query’s fingerprint</td>
</tr>
<tr>
<td style="text-align:center">Response time</td>
<td style="text-align:center">The total response time, and percentage of overall total</td>
</tr>
<tr>
<td style="text-align:center">Calls</td>
<td style="text-align:center">The number of times this query was executed</td>
</tr>
<tr>
<td style="text-align:center">R/Call</td>
<td style="text-align:center">The mean response time per execution</td>
</tr>
<tr>
<td style="text-align:center">V/M</td>
<td style="text-align:center">The Variance-to-mean ratio of response time</td>
</tr>
<tr>
<td style="text-align:center">Item</td>
<td style="text-align:center">The distilled query</td>
</tr>
</tbody>
</table>
<ul>
<li>第三部分，每个被统计的查询的详细信息</li>
</ul>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"> # Query <span class="number">1</span>: <span class="number">0</span> QPS, <span class="number">0</span>x concurrency, ID <span class="number">0x106F26B3D217B2C9</span> at byte <span class="number">0</span> ________</span><br><span class="line"> # This item is included <span class="keyword">in</span> the report because it matches --limit.</span><br><span class="line"> # Scores: V/M = <span class="number">0.00</span></span><br><span class="line"> # Time range: all events occurred at <span class="number">2017</span><span class="number">-10</span><span class="number">-13</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">25</span></span><br><span class="line"> # Attribute    pct   total     min     max     avg     <span class="number">95</span>%  stddev  median</span><br><span class="line"> # ============ === ======= ======= ======= ======= ======= ======= =======</span><br><span class="line"> # Count         <span class="number">50</span>       <span class="number">1</span></span><br><span class="line"> # Exec time     <span class="number">65</span>      <span class="number">1</span>s      <span class="number">1</span>s      <span class="number">1</span>s      <span class="number">1</span>s      <span class="number">1</span>s       <span class="number">0</span>      <span class="number">1</span>s</span><br><span class="line"> # Lock time     <span class="number">35</span>    <span class="number">63</span>us    <span class="number">63</span>us    <span class="number">63</span>us    <span class="number">63</span>us    <span class="number">63</span>us       <span class="number">0</span>    <span class="number">63</span>us</span><br><span class="line"> # Rows sent      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span></span><br><span class="line"> # Rows examine   <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span></span><br><span class="line"> # Rows affecte   <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span></span><br><span class="line"> # Rows read      <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span></span><br><span class="line"> # Bytes sent    <span class="number">15</span>      <span class="number">11</span>      <span class="number">11</span>      <span class="number">11</span>      <span class="number">11</span>      <span class="number">11</span>       <span class="number">0</span>      <span class="number">11</span></span><br><span class="line"> # Tmp tables     <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span></span><br><span class="line"> # Tmp disk tbl   <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span></span><br><span class="line"> # Tmp tbl size   <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span></span><br><span class="line"> # Query size    <span class="number">44</span>     <span class="number">121</span>     <span class="number">121</span>     <span class="number">121</span>     <span class="number">121</span>     <span class="number">121</span>       <span class="number">0</span>     <span class="number">121</span></span><br><span class="line"> # String:</span><br><span class="line"> # Hosts</span><br><span class="line"> # Last errno   <span class="number">0</span></span><br><span class="line"> # Users        root</span><br><span class="line"> # Query_time distribution</span><br><span class="line"> #   <span class="number">1</span>us</span><br><span class="line"> #  <span class="number">10</span>us</span><br><span class="line"> # <span class="number">100</span>us</span><br><span class="line"> #   <span class="number">1</span>ms</span><br><span class="line"> #  <span class="number">10</span>ms</span><br><span class="line"> # <span class="number">100</span>ms</span><br><span class="line"> #    <span class="number">1</span>s  ################################################################</span><br><span class="line"> #  <span class="number">10</span>s+</span><br><span class="line">GRANT REPLICATION SLAVE ON *.* TO <span class="string">'repl'</span>@<span class="string">'10.27.139.%'</span> IDENTIFIED BY PASSWORD <span class="string">'*5C2A4F610EF47B9C3C868FF5E88A69965D887ED4'</span>\G</span><br></pre></td></tr></table></figure>
<h4 id="常见操作"><a href="#常见操作" class="headerlink" title="常见操作"></a>常见操作</h4><ul>
<li>分析最近12小时内的查询</li>
</ul>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@archpredb214 lianxi]# <span class="regexp">/home/my</span>sql<span class="regexp">/mysql_tools/</span>pt-query-digest  --since=<span class="number">12</span>h <span class="regexp">/mysql/</span>data<span class="regexp">/archpredb214-slow.log  &gt;anal1.txt</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>分析指定时间范围内的查询</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@archpredb214</span> lianxi]<span class="meta"># /home/mysql/mysql_tools/pt-query-digest  <span class="string">'unixtimestamp1'</span> –until  <span class="string">'unixtimestamp2'</span> &gt;anal2.txt</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>–filter参数是一个很强大的选项，甚至可以自己创造一些输出,这里只是列举一些常见的输出</p>
</li>
</ul>
<blockquote>
<ul>
<li><p>分析只含有select语句的慢查询</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@archpredb214 lianxi]# <span class="regexp">/home/my</span>sql<span class="regexp">/mysql_tools/</span>pt-query-digest  --filter <span class="string">'$event-&gt;&#123;fingerprint&#125; =~ m/^select/i'</span> <span class="regexp">/mysql/</span>data<span class="regexp">/archpredb214-slow.log  &gt;anal3.txt</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>针对某个用户的慢查询</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@archpredb214 lianxi]# <span class="regexp">/home/my</span>sql<span class="regexp">/mysql_tools/</span>pt-query-digest  --filter  <span class="string">'($event-&gt;&#123;user&#125; || "") =~ m/^root/i'</span> <span class="regexp">/mysql/</span>data<span class="regexp">/archpredb214-slow.log  &gt;anal4.txt</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>所有的全表扫描或full join的慢查询</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@archpredb214 lianxi]# /home/mysql/mysql_tools/pt-<span class="keyword">query</span>-digest  --filter  '((<span class="variable">$event</span>-&gt;&#123;Full_scan&#125; || <span class="string">""</span>) <span class="keyword">eq</span> <span class="string">"yes"</span>) || ((<span class="variable">$event</span>-&gt;&#123;Full_join&#125; || <span class="string">""</span>) <span class="keyword">eq</span> <span class="string">"yes"</span>)'  /mysql/data/archpredb214-slow.<span class="keyword">log</span>  &gt;anal5.txt</span><br></pre></td></tr></table></figure>
</li>
<li><p>其他更详细的示例参考percona官方文档。</p>
</li>
</ul>
</blockquote>
<p><a href="https://www.cnblogs.com/maifengqiang/p/3863168.html" target="_blank" rel="noopener">超级详细Tcpdump的用法</a></p>
<p> <a href="http://blog.csdn.net/lijingkuan/article/details/50759987" target="_blank" rel="noopener">tcpdump&amp;pt-query-digest分析mysql负载性能问题</a></p>
<p> <a href="https://www.percona.com/doc/percona-toolkit/2.2/pt-query-digest.html" target="_blank" rel="noopener">官方文档</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/02/07/shell/" rel="next" title="">
                <i class="fa fa-chevron-left"></i> 
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/02/07/time、os、subprocess/" rel="prev" title="">
                 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">杨昆</p>
              <p class="site-description motion-element" itemprop="description">社会主义五讲四美骚年王</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#tcpdump-pt-query-digest"><span class="nav-number">1.</span> <span class="nav-text">tcpdump+pt-query-digest</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#tcpdump"><span class="nav-number">1.1.</span> <span class="nav-text">tcpdump</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pt-query-digest"><span class="nav-number">1.2.</span> <span class="nav-text">pt-query-digest</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#常见操作"><span class="nav-number">1.2.1.</span> <span class="nav-text">常见操作</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">杨昆</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
